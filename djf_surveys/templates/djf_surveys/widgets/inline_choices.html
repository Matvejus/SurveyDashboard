{% load i18n %}

<!-- Hidden field template remains the same -->
<input type="{{ widget.type }}" name="{{ widget.name }}"{% if widget.value != None %} value="{{ widget.value }}"{% endif %}{% include "django/forms/widgets/attrs.html" %} style="display:none;">

<div id="djf-wrapper-{{ widget.field_type }}">
    {% for value in widget.choice_value %}
        <div class="relative mb-2 djf-field-choice">
            <input 
                type="text" 
                name="{{ widget.name }}_{{ forloop.counter }}"{% include "djf_surveys/widgets/attrs_exclude_id.html" %}
                value="{{ value }}"
                class="djf-input-field w-6 h-6 border border-gray-200 rounded-md mb-4"
                oninput="updateWidgetValue()">
            <div class="absolute top-2 right-2">
                <button class="djf-btn-remove-field py-2 px-2 text-white rounded-lg bg-red-500 hover:bg-red-600" type="button">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 stroke-white hover:stroke-white" fill="none" viewBox="0 0 24 24" stroke="currentColor">#}
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                    </svg>
                </button>
            </div>
        </div>
    {% endfor %}
    
    {% for _ in widget.extra %}
        <div class="relative mb-2 djf-field-{{ widget.field_type }}">
            <input 
            type="text" 
            name="{{ widget.name }}_{{ extra }}"{% include "djf_surveys/widgets/attrs_exclude_id.html" %}
            class="djf-input-field w-6 h-6 border border-gray-200 rounded-md mb-4"
            oninput="updateWidgetValue()">
            <div class="absolute top-2 right-2">
                <button class="djf-btn-remove-field py-2 px-2 text-white rounded-lg bg-red-500 hover:bg-red-600" type="button">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 stroke-white hover:stroke-white" fill="none" viewBox="0 0 24 24" stroke="currentColor">#}
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                    </svg>
                </button>
            </div>
        </div>
    {% endfor %}
</div>

<button class="py-2 px-2 text-white rounded-lg bg-blue-500 hover:bg-blue-600" type="button" id="djf-btn-add-field-{{ widget.field_type }}">
    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 float-left" fill="none" viewBox="0 0 24 24" stroke="currentColor">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6"></path>
    </svg>
</button>
<span class="ml-3 font-medium">{{ widget.choice_label }}</span>


<script>
    document.addEventListener('DOMContentLoaded', function() {
        let fieldWrapperPrefix = 'djf-wrapper-';
        let addButtonPrefix = 'djf-btn-add-field-';

        // Function to update the value of the widget based on the input fields
        function updateWidgetValue(widgetName, widgetFieldType) {
            let djfField = [...document.getElementsByClassName(`djf-field-${widgetFieldType}`)];
            let values = djfField.map(e => e.querySelector('input').value).filter(el => el != "");
            document.getElementById("id_" + widgetName).value = values.join(",");
        }

        // Function to add a new field
        function addField(wrapper, widgetName, widgetFieldType, baseNode) {
            const newNode = baseNode.cloneNode(true);
            const lastFieldIndex = wrapper.getElementsByClassName(`djf-field-${widgetFieldType}`).length;
            newNode.querySelector('input').setAttribute("name", `${widgetName}_${widgetFieldType}_${lastFieldIndex + 1}`);
            newNode.querySelector('input').value = "";
            wrapper.appendChild(newNode);
            initFieldEvents(wrapper, widgetName, widgetFieldType); // Reinitialize the event listeners
        }

        // Function to remove a field
        function removeField(event, widgetName, widgetFieldType) {
            let fieldContainer = event.target.closest(`.djf-field-${widgetFieldType}`);
            const wrapper = document.getElementById(`${fieldWrapperPrefix}${widgetFieldType}`);
            if (wrapper.getElementsByClassName(`djf-field-${widgetFieldType}`).length > 1) { // Ensure at least one field remains
                fieldContainer.remove();
                updateWidgetValue(widgetName, widgetFieldType); // Update the widget value after removal
            } else {
                alert("At least one field is required.");
            }
        }

        // Function to initialize event listeners for add and remove buttons
        function initFieldEvents(wrapper, widgetName, widgetFieldType) {
            let addButton = document.getElementById(`${addButtonPrefix}${widgetFieldType}`);
            let removeButtons = wrapper.querySelectorAll('.djf-btn-remove-field');
            let baseNode = wrapper.querySelector(`.djf-field-${widgetFieldType}`);

            // Add field event
            addButton.onclick = () => addField(wrapper, widgetName, widgetFieldType, baseNode);

            // Remove field events
            removeButtons.forEach(btn => {
                btn.onclick = (event) => removeField(event, widgetName, widgetFieldType);
            });
        }

        // Initialize for both 'edit' and 'choice' field types
        ['edit', 'choice'].forEach(fieldType => {
            const widgetName = "{{ widget.name }}"; // Adjust this if necessary
            const wrapper = document.getElementById(`${fieldWrapperPrefix}${fieldType}`);
            if (wrapper) { // Check if the wrapper exists for the fieldType
                initFieldEvents(wrapper, widgetName, fieldType);
            }
        });
    });
</script>